---
title: Generating HC synovium network
subtitle: 'network generation'
output: 
  html_document:
    toc: true
    toc_depth: 6
editor_options: 
  chunk_output_type: console
---

# Took the code from Shiran Vainberg (Who run it on AD for the J&J project) - customized it to RA/HC
------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, eval = FALSE)
options(DT.fillContainer = TRUE)
```

# 1 -- Setup

load libraries

```{r, include=T, echo = T}

Sys.setenv(GITHUB_PAT = system("coder external-auth access-token cyto-github", intern = TRUE))
#library(cytoreason.platform.client)
#install.packages("cytoreason.platform")
library(cytoreason.platform)
#install.packages("cytoreason.platform.catalog")
library(cytoreason.platform.catalog)

devtools::load_all("~/capsule/code/cytoreason.ccm.pipeline/") #branch service/custom-geneset-collection
options(cytoreason.cache_directory = "~/capsule/scratch/cytoreason_cache/cache",
        cytoreason.asset_directory = "~/capsule/scratch/cytoreason_cache/asset_files",
        "cytoreason.datasource:cache" = "~/capsule/scratch/cytoreason_cache/cach",
        stringsAsFactors = FALSE, # always good to set to FALSE
        nwarnings = 10000 # capture all warnings
)


#install additional public packages
library(stringr)
library(dplyr)
library(checkmate)
library(testthat)
library(scales)
library(igraph)
library(visNetwork)
library(AnnotationDbi)
library(org.Hs.eg.db)
#install.packages("patchwork")
library(patchwork)
library(ggplot2)
library(bigrquery)

source("~/capsule/code/analysis-p01-ra-target/R/gil_eshel.R") # need the functions that I used for cor_mat generation, mean centrality and intra-density calculation functions

retrive_me <- function(my_object = my_object ){
  return(my_object)
}


```


# 2 -- network generation

<details>

<summary>full network generation</summary>

## 2.1 -- full network generation

### inputs 

input ccm (generic model)
```{r }
ccm_fit_RA <- "wf-0e9003bd43"
ra.ccm = as_ccm_fit(ccm_fit_RA)
ra.config = modelMetadata(ra.ccm) # to create the modified config needed for get_res_dist

model_team_bulk_full_nw <- "wf-7a1168f2fb" #the RA bulk conserved nw (Daniel Weizman run it)
n_inputs <- get_task_inputs(model_team_bulk_full_nw ,task_id="0")
n_inputs <- sapply(n_inputs, readRDS)


```

input esets
```{r }

#subset for HC samples only and filter esets with less than 5 samples

.get_esets_ccm <- function(ccmfit, esets_names=NULL) {
  if (is.null(esets_names)) {
    esets_names <- names(ccmfit$datasets)
  }
  esets <- lapply(esets_names, function(nam) assayDataExpression(ccmfit, nam))
  names(esets) <- esets_names
  esets
}

# I went through the datasets in the model, excluded the outlier datasets based on the MT dataset-cor QC, and datasets with only 5 RA samples:
healty_datasets <- subset(ra.config,comparison=="DZ_VS_HC")$dataset_id # datasets with healthy samples

HC_esets_orig <- .get_esets_ccm(ra.ccm, esets_names = healty_datasets)
n_HC_samples_per_dataset <- lapply(names(HC_esets_orig),function(cur_eset){sum(pData(HC_esets_orig[[cur_eset]])$condition %in% "healthy")}) # between 6 and 28 samples

# Filter the samples to only HC samples that passed QC:
esets_nw <- lapply(names(HC_esets_orig), function(cur_eset){
  sub_e <- HC_esets_orig[[cur_eset]][,pData(HC_esets_orig[[cur_eset]])$condition %in% "healthy"]
  if(any(pData(sub_e)$validator_qc %in% "Exclude")) {
    sub_e <- sub_e[,!pData(sub_e)$validator_qc %in% "Exclude"]
  }
  exclude_samp <- unique(ra.config$exclude_samples)[!is.na(unique(ra.config$exclude_samples))]
  if(any(pData(sub_e)$sample_id %in% exclude_samp)) {
    sub_e <- sub_e[,!pData(sub_e)$sample_id %in% exclude_samp]
  }
  if(dim(sub_e)[2]<=5){
    NA
  }else{
    sub_e
  }
})
names(esets_nw) <- names(HC_esets_orig)

do.call('rbind',lapply(names(esets_nw),function(d){ # get the number of included samples per dataset
  n_samples <- ncol(esets_nw[[d]])
  data.frame(dataset=d,n_samples=n_samples)
}))

esets_nw <- lapply(esets_nw, function(cur_e) {
  pData(cur_e)$nw <- "HC"
  return(cur_e)
})

group_table <- data.frame(experiment_id=names(esets_nw),
                          group_variable="nw",
                          reference_category="HC")


```

input genes
```{r}

#use all genes for the gene_list argument in the nw pipeline
gene_list <- list(all=unique(do.call('c', lapply(HC_esets_orig, function(cur_eset) {
  featureNames(cur_eset)
}))
))
```


### run full correlation network pipeline

```{r }
(wfid <- run_method_dist(method="service_generate_modules", 
                         ns=n_inputs$ns, 
                         assay_element=n_inputs$assay_element, 
                         edge_list.args=n_inputs$edge_list.args,
                         esets=esets_nw, 
                         disease="healthy",
                         gene_list=gene_list,
                         group_table = group_table,
                         memory_request_modules=n_inputs$memory_request_modules, 
                         image_modules="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:master_1.1.11",
                         steps="full_corr_matrix", 
                         module.args=n_inputs$module.args,
                         memory_request = "50Gi",
                         image="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:master_1.1.11"))

# wf-64bd1be2a8 # SUCCEEDED
get_workflow_progress(c('wf-64bd1be2a8'))


length(unique(full_cor_obj$gene_table$ENTREZID))
hist(full_cor_obj$edge_meta$q_pvalue)

dim(subset(full_cor_obj$edge_meta,q_pvalue>=0.02&fdr<=0.05))

```

### check outlier datasets

Identify outlier datasets

```{r }

#within wf-64bd1be2a8 there is the full_corr_matrix step that is stored as a wf:
wf_non_conserv_bulk_HC <- "wf-054a6af875"
get_workflow_progress(c('wf-054a6af875')) # SUCCEEDED

full_cor_obj <- readRDS(get_workflow_outputs(wf_non_conserv_bulk_HC))
wf_dataset_specific <- full_cor_obj[["data_specific_info"]] #the output is wf
wf_dataset_specific
#wf-f664d828ed

wf_dataset_specific <- "wf-f664d828ed"
(wfid_outlier_check <- run_method_dist(method=".check_outliers_remote", 
                                       ns="analysis.p03.POC1",
                                       reference_edges=get_workflow_id((wf_dataset_specific)),
                                       cor = "cor",
                                       edge = "edge",
                                       output_dir="./output",
                                       mem_req='10Gi',
                                       cyto_cc_force_execution=T,
                                       image_url="eu.gcr.io/cytoreason/ci-analysis.p03.poc1-package:shiran_API_latest",
                                       image="eu.gcr.io/cytoreason/ci-analysis.p03.poc1-package:shiran_API_latest"))

#wf-9cc5a3100f
get_workflow_progress(c('wf-9cc5a3100f')) # SUCCEEDED
oulier_res <- readRDS(get_workflow_outputs("wf-9cc5a3100f")[1])

#--- plot outlier results ---

# ht <- Heatmap(oulier_res,
#               rect_gp = gpar(col = "white", lwd = 2), row_title = NULL,
#               col=c("#f0e3ab", "#f49d77", "#ce5f5f", "#b23030"),
#               name="ccorrelation", 
#               row_names_gp = gpar(fontsize = 8), 
#               column_names_gp = gpar(fontsize = 7), show_row_names = TRUE, show_column_names = T,
#               column_names_rot = 90, column_names_max_height = unit(10,"cm"), 
#               cell_fun = function(j, i, x, y, width, height, fill) {
#                 grid.text(sprintf("%.2f", oulier_res[i,j]), x, y, gp = gpar(fontsize = 10))})
# 
# draw(ht, padding = unit(c(2, 2, 2, 90), "mm"), heatmap_legend_side = "left") #bottom, left, top, right paddings

library(pheatmap)

# Define a color palette with sufficient length
color_palette <- colorRampPalette(c("#f0e3ab", "#f49d77", "#ce5f5f", "#b23030"))(100)

# Create a heatmap with pheatmap
ht <- pheatmap(
  oulier_res,
  color = color_palette, # Use the color palette with a gradient
  display_numbers = TRUE, # Show cell values
  number_format = "%.2f", # Format values to 2 decimal places
  number_color = "black", # Set number color
  fontsize = 8, # Font size for matrix values
  fontsize_row = 8, # Row name font size
  fontsize_col = 7, # Column name font size
  angle_col = 90, # Rotate column names to 90 degrees
  border_color = "white" # White borders
)

ht

#distribution of correlations per dataset
oulier_res_long <- reshape2::melt(oulier_res)
ggplot(oulier_res_long, aes(x = value, y=Var2)) +
  ggridges::geom_density_ridges2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text = element_text(size=7))+
  ylab("correlation of correlations")+ xlab("correlation")+
  #ylab("correlation of correlations")+ xlab("FDR val")+
  theme_bw()+
  theme(strip.text = element_text(size=8), panel.grid.major = element_blank(),
        axis.text.y=element_text( size=8),
        axis.text.x=element_text(size=8, angle=90),
        panel.grid.minor = element_blank(),                                            
        strip.background = element_blank(),
        panel.border =element_blank(),
        legend.position = "left",
        axis.ticks.length=unit(.15, "cm"))

res <- do.call('rbind', lapply(unique(oulier_res_long$Var2), function(cur_dataset) {
  sub <- oulier_res_long[oulier_res_long$Var2 %in% cur_dataset,]
  data.frame(dataset=cur_dataset, mean=mean(sub$value), median=median(sub$value), stringsAsFactors = F)
}))

```

rerun the networks excluding the outlier datasets

```{r}

#--- define outlier datasets ---

DefineOutliers = oulier_res_long %>%
  dplyr::filter(Var1 != Var2) %>%
  group_by(Var1) %>%
  dplyr::summarise(max = max(value),
                   median = median(value))
                   
Outliers = DefineOutliers %>%
  dplyr::filter(max <= 0.2 | median <= 0.1)  %>%
  pull(Var1) %>%
  as.character()

Outliers = "GSE55457__GPL96" # all have very low correlations, this one have cor≤0.11
#--- use Adir's improved code to run the full correlation nw ---

wf_non_conserv_bulk_HC <- "wf-054a6af875"
bb <- get_task_inputs(wf_non_conserv_bulk_HC,task_id = 0,should_download_files = T)
bb <- sapply(bb, readRDS)

group_table <- bb$group_table %>%
  dplyr::filter(!experiment_id %in% Outliers)
assay_element <- bb$assay_element
def_data_specific_edges <- bb$def_data_specific_edges
edge_min_count <- bb$edge_min_count

gene_based <- bb$gene_based
esets <- bb$esets[!(names(bb$esets) %in% Outliers)]
gene_list <- list(all=unique(do.call('c', lapply(esets, function(cur_eset) {
  featureNames(cur_eset)
}))))

net_id <- bb$net_id
to_propagate <- bb$to_propagate
method <- bb$method
min_n_genes <- length(gene_list$all) - 1
ns <- bb$ns
to_prune <- bb$to_prune
lean_output <- bb$lean_output
max_n_genes <- length(gene_list$all) +1


IMAGE <- "eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:SUP_4695_1.2.0"

(step_full_corr_matrix_wfid_bulk <- run_method_dist(method="step_edge_meta_analysis",
                                              ns="cytoreason.individual.variation",
                                              gene_list = gene_list,
                                              min_n_genes = min_n_genes,
                                              max_n_genes = max_n_genes,
                                              esets = esets,
                                              group_table = group_table,
                                              def_data_specific_edges=def_data_specific_edges,
                                              gene_based = TRUE,
                                              assay_element = assay_element,
                                              to_propagate = FALSE,
                                              to_prune = FALSE,
                                              lean_output = FALSE,
                                              net_id = net_id,
                                              IMAGE = IMAGE,
                                              image = IMAGE,
                                              tags = list(list(name = "step", value = "full_corr_matrix")),
                                              edge_min_count = 0, force_execution = TRUE, 
                                              memory_request = "80Gi"))

#wf-7bc0286215 bulk - image 1.2.0
get_workflow_progress(c('wf-7bc0286215')) # SUCCEEDED

# Check the edge heterogeneity distribution - is q_pvalue≥0.02 is uniformly distributed (or do we still need FDR correction)?
HC_network_bulk <- readRDS(get_workflow_outputs("wf-7bc0286215"))
HC_nw_bulk_q_pvalue_hist <- ggplot(HC_network_bulk$edge_meta, aes(x = q_pvalue)) +
  geom_histogram(binwidth = 0.005, fill = "skyblue", color = "black") +
  geom_vline(xintercept = 0.02, linetype = "dashed", color = "red", linewidth = 1) +
  labs(title = paste0("HC q_pvalue distribution"),
       x = "Edge q_pvalue",
       y = "No. edges") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_q_pvalue_distribution.pdf"), plot = HC_nw_bulk_q_pvalue_hist)


###

(step_full_corr_matrix_wfid_adjusted <- run_method_dist(method="step_edge_meta_analysis",
                                                   ns="cytoreason.individual.variation",
                                                   gene_list = gene_list,
                                                   min_n_genes = min_n_genes,
                                                   max_n_genes = max_n_genes,
                                                   esets = esets,
                                                   group_table = group_table,
                                                   def_data_specific_edges=def_data_specific_edges,
                                                   gene_based = TRUE,
                                                   assay_element = "exprs_adjusted__1__1", #"adjusted__1__1",
                                                   to_propagate = FALSE,
                                                   to_prune = FALSE,
                                                   lean_output = FALSE,
                                                   net_id = net_id,
                                                   IMAGE = IMAGE,
                                                   image = IMAGE,
                                                   tags = list(list(name = "step", value = "full_corr_matrix")),
                                                   edge_min_count = 0, force_execution = TRUE, 
                                                   memory_request = "80Gi"))
#wf-7727a15c95 # with "exprs_adjusted__1__1"
get_workflow_progress(c('wf-7727a15c95')) # SUCCEEDED

#wf-7727a15c95 - # with "adjusted__1__1"
get_workflow_progress(c('wf-7727a15c95')) # ERROR

```

</details>

<details>

<summary>Prune network</summary>

## 2.2  --prune network

pruning includes the following cutoffs: - filter fdr\<0.05, - Chochrane's Q \> 0.02 - testing a range of correlation cutoffs. The optimal correlation cut point is the highest possible cutoff that preserves the majority of nodes and minimize the number of edges.

```{r}

Multiple_cut_NW <- run_method_dist(method="filter_nw", 
                                  ns="analysis.p03.POC1",
                                  NW_WFID = "wf-7bc0286215",
                                  cor_cut_seq = seq(0,.8,.05),
                                  memory_request='40Gi',
                                  image="eu.gcr.io/cytoreason/ci-analysis.p03.poc1-package:AJ_analysis_latest")
#wf-2abbb8d3a8 - bulk
get_workflow_progress(c('wf-2abbb8d3a8')) # SUCCEEDED


Multiple_cut_NW <- run_method_dist(method="filter_nw", 
                                  ns="analysis.p03.POC1",
                                  NW_WFID = "wf-7727a15c95",
                                  cor_cut_seq = seq(0,.8,.05),
                                  memory_request='40Gi',
                                  image="eu.gcr.io/cytoreason/ci-analysis.p03.poc1-package:AJ_analysis_latest")
# wf-266c522a2d -  adj
get_workflow_progress(c('wf-266c522a2d')) # SUCCEEDED


#### Read metrics cross cutoff ###

Bulk_CutoffData <- read_data(AssetData("wf-2abbb8d3a8:0:output.rds"))
Bulk_multicut.combo  <- bind_rows(Bulk_CutoffData)
write.csv(Bulk_multicut.combo,"~/capsule/scratch/RA_network/HC_BulkNW_CutoffInfo.csv",row.names=F)


Nodes <- Bulk_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nNodes)) +
  geom_point() + geom_line() + theme_minimal() +
  theme(aspect.ratio = .7) +
  ggtitle("HC Bulk NW")

Edges <- Bulk_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nEdges)) +
  geom_point() + geom_line() + theme_minimal() + 
  theme(aspect.ratio = .7) 

ConnectedNodes <- Bulk_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nConnectedGenes)) +
  geom_point() + geom_line() + theme_minimal() + 
  theme(aspect.ratio = .7)

Nodes + Edges + ConnectedNodes + plot_layout(ncol = 1)
ggsave("~/capsule/scratch/RA_network/HC_Bulk_NW_Filter.pdf") # .tiff

# Pareto front:
Paretofront <- Bulk_multicut.combo %>%
  ggplot(aes(x = nNodes, y = nEdges, color = factor(cor_cut))) +
  geom_point() + 
  geom_line() + 
  geom_text(aes(label = cor_cut), vjust = -0.5, hjust = 0.5, size = 3) +  # Add labels with slight offset
  theme_minimal() + 
  theme(aspect.ratio = .7, legend.position = "none") +  # Remove color legend
  labs(x = "No. nodes", y = "No. edges")  # Change axis titles
ggsave("~/capsule/scratch/RA_network/HC_Bulk_NW_Pareto_front.pdf")

# Looks like r cutoff should be either 0.65 or 0.6

Adj_CutoffData <- read_data(AssetData("wf-266c522a2d:0:output.rds"))
Adj_multicut.combo  = bind_rows(Adj_CutoffData)
write.csv(Bulk_multicut.combo,"~/capsule/scratch/RA_network/HC_AdjNW_CutoffInfo.csv")

Nodes <- Adj_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nNodes)) +
  geom_point() + geom_line() + theme_minimal() 
  theme(aspect.ratio = .7) +
  ggtitle("HC Adj NW") 

Edges <- Adj_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nEdges)) +
  geom_point() + geom_line() + theme_minimal() 
  theme(aspect.ratio = .7) 
ConnectedNodes = Adj_multicut.combo %>%
  ggplot(aes(x = cor_cut,y = nConnectedGenes)) +
  geom_point() + geom_line() + theme_minimal() 
  theme(aspect.ratio = .7) 


Nodes + Edges + ConnectedNodes + plot_layout(ncol = 1)
ggsave("~/capsule/scratch/RA_network/HC_Adj_NW_Filter.pdf") # .tiff


#Retrieve Igraph and edge table from specific cor cutoff
# r ≥ 0.5
bulk_wf_res <- get_workflow_outputs("wf-2abbb8d3a8")
bulk_wf_outputs_0.5 <- readRDS(bulk_wf_res['igraph_NW_sub_0.5.rds',1])
nw_bulk_pruned <- igraph::as_data_frame(bulk_wf_outputs_0.5, what = "edges")
colnames(nw_bulk_pruned)[colnames(nw_bulk_pruned) %in% "from"] <- "var1"
colnames(nw_bulk_pruned)[colnames(nw_bulk_pruned) %in% "to"] <- "var2"

cyto_cc_push_object(nw_bulk_pruned,"hc_nw_bulk_pruned_0.5") # long format (gene/gene/cor)
(cytoreason.cc.client::run_function_dist(retrive_me,my_object=nw_bulk_pruned,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-
get_workflow_progress(c('wf-')) # WAITING
nw_bulk_pruned <- readRDS(get_workflow_outputs("wf-"))

#Shiran's: wf-a7057224d0

get_cor_matrix <- function(nw_pruned){
  on.exit(gc())
  # Convert to wide format:
  nw_pruned_mat <- reshape2::dcast(nw_pruned[, c("var1", "var2", "cor")], var1 ~ var2, value.var = "cor")
  rownames(nw_pruned_mat) <- nw_pruned_mat[["var1"]]
  nw_pruned_mat[["var1"]] <- NULL
  nw_pruned_mat <- as.matrix(nw_pruned_mat)
  #
  # Ensure matrix has all unique row and column names
  all_names <- union(rownames(nw_pruned_mat), colnames(nw_pruned_mat))
  new_nw_pruned_mat <- matrix(NA, nrow = length(all_names), ncol = length(all_names))
  rownames(new_nw_pruned_mat) <- colnames(new_nw_pruned_mat) <- all_names
  #
  # Fill the new matrix with values from the original matrix
  nw_pruned_mat_df <- as.data.frame(as.table(nw_pruned_mat), stringsAsFactors = FALSE)
  new_nw_pruned_mat[cbind(match(nw_pruned_mat_df$Var1, all_names), match(nw_pruned_mat_df$Var2, all_names))] <- nw_pruned_mat_df$Freq
  #
  # Order rows and columns
  new_nw_pruned_mat <- new_nw_pruned_mat[order(rownames(new_nw_pruned_mat)), order(colnames(new_nw_pruned_mat))]
  nw_pruned_mat <- as.matrix(new_nw_pruned_mat)
  diag(nw_pruned_mat) <- 1
  #
  # Make the matrix symmetrical
  make_symmetric <- function(mat) {
    mat[lower.tri(mat)] <- t(mat)[lower.tri(mat)]
    return(mat)
  }
  #
  nw_pruned_mat <- make_symmetric(nw_pruned_mat)
  return(nw_pruned_mat)
}

nw_bulk_pruned_mat <- get_cor_matrix(nw_bulk_pruned)
gc()
cyto_cc_push_object(nw_bulk_pruned_mat,"hc_nw_bulk_pruned_mat_0.5") # cor matrix (r≥0.5, FDR≤0.05, q≥0.02)
(cytoreason.cc.client::run_function_dist(retrive_me,my_object=nw_bulk_pruned_mat,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-2f4bc1c967
get_workflow_progress(c('wf-2f4bc1c967')) # SUCCEEDED
nw_bulk_pruned_mat <- readRDS(get_workflow_outputs("wf-2f4bc1c967"))

# Adjusted:
adj_wf_res <- get_workflow_outputs("wf-266c522a2d")
adj_wf_outputs_0.55 <- readRDS(adj_wf_res['igraph_NW_sub_0.55.rds',1])
nw_adj_pruned = igraph::as_data_frame(adj_wf_outputs_0.55, what = "edges")
colnames(nw_adj_pruned)[colnames(nw_adj_pruned) %in% "from"] <- "var1"
colnames(nw_adj_pruned)[colnames(nw_adj_pruned) %in% "to"] <- "var2"

cyto_cc_push_object(nw_adj_pruned,"hc_nw_adjusted_pruned_0.55") 
#wf-aeeeac9a85

```

</details>

# 3 -- network preparation for cataloging

<details>

<summary>full bulk network cataloging</summary>

### full bulk network

```{r, echo = T, eval = FALSE}

#get full bulk AD correlation network

bulk_network_wid <- "wf-7bc0286215"

#generate parquet file for the network

(wf <- run_function_dist(function(net){
    edges <- net[["edge_meta"]]
    arrow::write_parquet(edges, "output/edges.parquet")
    tools::md5sum("output/edges.parquet")
    
  },
  net = input_wf_output_file(bulk_network_wid, "0", "output.rds", load = TRUE),
  image = "eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:feature_AO_329_data_flow_latest",
  force_execution = FALSE,
  replace_image_tags = FALSE,
  memory_request = '30Gi'
))
wf <- "wf-6c18aac9a3"
get_workflow_progress(c('wf-6c18aac9a3')) # SUCCEEDED

```

</details>

<details>

<summary>pruned bulk network cataloging</summary>

### pruned bulk network

pruning includes the following cutoffs: - filter fdr\<0.05, - Chochrane's Q \> 0.02 - testing a range of correlation cutoffs. The optimal correlation cut point is the highest possible cutoff that preserves the majority of nodes and minimize the number of edges. (see network generation)

```{r}


#prune by selected cutoffs using the catalog functions
nw_sub_sub <- cr_catalog_get_table(
  catalog="cr-d73dacdf0e", 
  name="edges", 
    subset= ~ sub_type %in% "full",
   filter= ~
    cor >= 0 & 
    fdr <= 0.05 &
  q_pvalue >= 0.02
  )

cyto_cc_push_object(nw_sub_sub,"bulk_nw_pruned") 
#wf-7c63d75bef


#catalog the pruned network

wf_nw_bulk_0.5_pruned <- run_function_dist(function(net){
    edges <- net
    arrow::write_parquet(edges, "output/edges.parquet")
    tools::md5sum("output/edges.parquet")
    
  },
  net =nw_sub_sub,
  image = "eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:feature_AO_329_data_flow_latest",
  force_execution = FALSE,
  replace_image_tags = FALSE,
  memory_request = '3Gi'
  )

wf_nw_bulk_0.5_pruned <- "wf-41537ec141"

```

</details>

<details>

<summary>full adjusted network cataloging</summary>

### full adjusted network 

```{r}


#get full adjusted AD correlation network post filtering of 4 datasets

adjusted_network_wid <- "wf-7727a15c95"

#generate parquet file for the network

wf <- run_function_dist(function(net){
    edges <- net[["edge_meta"]]
    arrow::write_parquet(edges, "output/edges.parquet")
    tools::md5sum("output/edges.parquet")
    
  },
  net = input_wf_output_file(adjusted_network_wid, "0", "output.rds", load = TRUE),
  image = "eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:feature_AO_329_data_flow_latest",
  force_execution = FALSE,
  replace_image_tags = FALSE,
  memory_request = '30Gi'
  )

wf <- "wf-b71633040a"
```

</details>

<details>

<summary>pruned adjusted network cataloging</summary>

### pruned adjusted network

```{r }
#prune by the selected cutoffs from the calatog

adj_nw_sub_sub <- cr_catalog_get_table(
  catalog="cr-332f2c5e7c", 
  name="edges", 
    subset= ~ sub_type %in% "full",
   filter= ~
    cor >= 0.55 & 
    fdr <= 0.05 &
  q_pvalue >= 0.02
  )
cyto_cc_push_object(adj_nw_sub_sub,"adj_nw_pruned") 

#wf-b2c8f284f5

#catalog the pruned network

wf_nw_adj_0.55_pruned <- run_function_dist(function(net){
    edges <- net
    arrow::write_parquet(edges, "output/edges.parquet")
    tools::md5sum("output/edges.parquet")
  },
  net =adj_nw_sub_sub,
  image = "eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:feature_AO_329_data_flow_latest",
  force_execution = FALSE,
  replace_image_tags = FALSE,
  memory_request = '3Gi'
  )

wf_nw_adj_0.55_pruned <- "wf-7c9cead349"

```

</details>

<details>

<summary>nodes with centrality of pruned bulk network</summary>

### nodes with centrality of pruned bulk network

```{r}

nw_bulk_pruned_wf <- "wf-2abbb8d3a8"
#nw_bulk_pruned <- readRDS(get_workflow_outputs(nw_bulk_pruned_wf))
results <-  get_workflow_outputs(nw_bulk_pruned_wf)

# Get the centrality based on r≥0.6 cutoff:
nw_bulk_pruned_0.6 <- readRDS(results['igraph_NW_sub_0.6.rds',1])
nw_bulk_pruned_0.6 <- igraph::as_data_frame(nw_bulk_pruned_0.6)
colnames(nw_bulk_pruned_0.6)[colnames(nw_bulk_pruned_0.6) %in% "from"] <- "var1"
colnames(nw_bulk_pruned_0.6)[colnames(nw_bulk_pruned_0.6) %in% "to"] <- "var2"

(wfid <- run_method_dist(method="centrality_measures",
                        ns="analysis.codename",
                        edges=nw_bulk_pruned_0.6[,c("var1","var2")],
                        memory_request='5Gi',
                        image="eu.gcr.io/cytoreason/ci-analysis.codename-package:adi_latest"))
#wf-26f40c7c9a
get_workflow_progress(c('wf-26f40c7c9a')) # SUCCEEDED

# Get the centrality based on r≥0.5 cutoff:
nw_bulk_pruned_0.5 <- readRDS(results['igraph_NW_sub_0.5.rds',1])
nw_bulk_pruned_0.5 <- igraph::as_data_frame(nw_bulk_pruned_0.5)
colnames(nw_bulk_pruned_0.5)[colnames(nw_bulk_pruned_0.5) %in% "from"] <- "var1"
colnames(nw_bulk_pruned_0.5)[colnames(nw_bulk_pruned_0.5) %in% "to"] <- "var2"

(wfid <- run_method_dist(method="centrality_measures",
                        ns="analysis.codename",
                        edges=nw_bulk_pruned_0.5[,c("var1","var2")],
                        memory_request='5Gi',
                        image="eu.gcr.io/cytoreason/ci-analysis.codename-package:adi_latest"))
#wf-3bd1a49a8b
get_workflow_progress(c('wf-3bd1a49a8b')) # SUCCEEDED
centrality_df_0.5 <- readRDS(get_workflow_outputs("wf-3bd1a49a8b"))
#

centrality_wf <- "wf-26f40c7c9a" # r≥0.6
centrality_df <- readRDS(get_workflow_outputs(centrality_wf))

HC_nw_bulk_pruned_0.6_degree_hist <- ggplot(centrality_df, aes(x = degree)) +
  geom_histogram(binwidth = 0.005, fill = "skyblue", color = "black") +
  labs(title = paste0("Degree distribution - HC network: FDR<0.05, q>0.02, r>0.6"),
       x = "Node degree",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_degree_distribution_r_0_6.pdf"), plot = HC_nw_bulk_pruned_0.6_degree_hist)

HC_nw_bulk_pruned_0.6_eigen_centrality_hist <- ggplot(centrality_df, aes(x = eigen_centrality)) +
  geom_histogram(binwidth = 0.05, fill = "skyblue", color = "black") +
  labs(title = paste0("Eigen centrality distribution - HC network: FDR<0.05, q>0.02, r>0.6"),
       x = "Node eigen centrality",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_eigen_centrality_distribution_r_0_6.pdf"), plot = HC_nw_bulk_pruned_0.6_eigen_centrality_hist)

HC_nw_bulk_pruned_0.6_betweenness_hist <- ggplot(centrality_df, aes(x = betweenness)) +
  geom_histogram(binwidth = 0.0005, fill = "skyblue", color = "black") +
  labs(title = paste0("Betweenness distribution - HC network: FDR<0.05, q>0.02, r>0.6"),
       x = "Node betweenness",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_betweenness_distribution_r_0_6.pdf"), plot = HC_nw_bulk_pruned_0.6_betweenness_hist)

HC_nw_bulk_pruned_0.6_page_rank_hist <- ggplot(centrality_df, aes(x = page_rank)) +
  geom_histogram(binwidth = 0.00005, fill = "skyblue", color = "black") +
  labs(title = paste0("Page rank distribution - HC network: FDR<0.05, q>0.02, r>0.6"),
       x = "Node page rank",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_page_rank_distribution_r_0_6.pdf"), plot = HC_nw_bulk_pruned_0.6_page_rank_hist)

HC_nw_bulk_pruned_0.6_closeness_hist <- ggplot(centrality_df, aes(x = closeness)) +
  geom_histogram(binwidth = 0.005, fill = "skyblue", color = "black") +
  labs(title = paste0("Closeness distribution - HC network: FDR<0.05, q>0.02, r>0.6"),
       x = "Node closeness",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_closeness_distribution_r_0_6.pdf"), plot = HC_nw_bulk_pruned_0.6_closeness_hist)


# Get the centrality based on r≥0.65 cutoff:
nw_bulk_pruned_0.65 <- readRDS(results['igraph_NW_sub_0.65.rds',1])
nw_bulk_pruned_0.65 <- igraph::as_data_frame(nw_bulk_pruned_0.65)
colnames(nw_bulk_pruned_0.65)[colnames(nw_bulk_pruned_0.65) %in% "from"] <- "var1"
colnames(nw_bulk_pruned_0.65)[colnames(nw_bulk_pruned_0.65) %in% "to"] <- "var2"

(wfid <- run_method_dist(method="centrality_measures",
                        ns="analysis.codename",
                        edges=nw_bulk_pruned_0.65[,c("var1","var2")],
                        memory_request='5Gi',
                        image="eu.gcr.io/cytoreason/ci-analysis.codename-package:adi_latest"))
#wf-a6ad5011bf
get_workflow_progress(c('wf-a6ad5011bf')) # SUCCEEDED

centrality_wf <- "wf-a6ad5011bf" # r≥0.65
centrality_df <- readRDS(get_workflow_outputs(centrality_wf))

HC_nw_bulk_pruned_0.65_degree_hist <- ggplot(centrality_df, aes(x = degree)) +
  geom_histogram(binwidth = 0.005, fill = "skyblue", color = "black") +
  labs(title = paste0("Degree distribution - HC network: FDR<0.05, q>0.02, r>0.65"),
       x = "Node degree",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_degree_distribution_r_0_65.pdf"), plot = HC_nw_bulk_pruned_0.65_degree_hist)

HC_nw_bulk_pruned_0.65_eigen_centrality_hist <- ggplot(centrality_df, aes(x = eigen_centrality)) +
  geom_histogram(binwidth = 0.05, fill = "skyblue", color = "black") +
  labs(title = paste0("Eigen centrality distribution - HC network: FDR<0.05, q>0.02, r>0.65"),
       x = "Node eigen centrality",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_eigen_centrality_distribution_0_65.pdf"), plot = HC_nw_bulk_pruned_0.65_eigen_centrality_hist)

HC_nw_bulk_pruned_0.65_betweenness_hist <- ggplot(centrality_df, aes(x = betweenness)) +
  geom_histogram(binwidth = 0.0005, fill = "skyblue", color = "black") +
  labs(title = paste0("Betweenness distribution - HC network: FDR<0.05, q>0.02, r>0.65"),
       x = "Node betweenness",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_betweenness_distribution_0_65.pdf"), plot = HC_nw_bulk_pruned_0.65_betweenness_hist)

HC_nw_bulk_pruned_0.65_page_rank_hist <- ggplot(centrality_df, aes(x = page_rank)) +
  geom_histogram(binwidth = 0.00001, fill = "skyblue", color = "black") +
  labs(title = paste0("Page rank distribution - HC network: FDR<0.05, q>0.02, r>0.65"),
       x = "Node page rank",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_page_rank_distribution_0_65.pdf"), plot = HC_nw_bulk_pruned_0.65_page_rank_hist)

HC_nw_bulk_pruned_0.65_closeness_hist <- ggplot(centrality_df, aes(x = closeness)) +
  geom_histogram(binwidth = 0.001, fill = "skyblue", color = "black") +
  labs(title = paste0("Closeness distribution - HC network: FDR<0.05, q>0.02, r>0.65"),
       x = "Node closeness",
       y = "No. nodes") +
  theme_minimal()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    plot.title = element_text(size = 10, hjust = 0.5,face='bold'))
ggsave(paste0("~/capsule/scratch/RA_network/HC_pruned_closeness_distribution_0_65.pdf"), plot = HC_nw_bulk_pruned_0.65_closeness_hist)


```

### Test if the centrality of bio. expected genes for HC are central more than random
```{r}

### Measure the performance of RA bio. exp. genes on the HC network:
RA_bio_exp <- readRDS(get_task_inputs("wf-796acc37e3","0")[["gene_list"]]) # From "Bio_exp_genes_from_Zhana_4_DMs.txt" (43 genes)
RA_bio_exp_symb <- AnnotationDbi::select(org.Hs.eg.db,keys = as.character(RA_bio_exp),columns = c("SYMBOL"),keytype = "ENTREZID")$SYMBOL

centrality_df_0.6 <- readRDS(get_workflow_outputs("wf-26f40c7c9a"))
centrality_df_0.65 <- readRDS(get_workflow_outputs("wf-a6ad5011bf"))

(mean_centrality_res_0.6_wf <- cytoreason.cc.client::run_function_dist(test_list_mean_centrality,DM="HC",cor_cut=0.6,centrality_df=centrality_df_0.6,gene_list_collection=list(RA_bio_exp=RA_bio_exp),n_rand_lists=10000,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-7dbdc1f632
get_workflow_progress(c('wf-7dbdc1f632')) # SUCCEEDED
mean_centrality_res_0.6 <- readRDS(get_workflow_outputs("wf-7dbdc1f632"))

#mean_centrality_res_0.65 <- test_list_mean_centrality(DM="HC",cor_cut=0.65,centrality_df=centrality_df_0.6,gene_list=RA_bio_exp,n_rand_lists=10000)
(mean_centrality_res_0.65_wf <- cytoreason.cc.client::run_function_dist(test_list_mean_centrality,DM="HC",cor_cut=0.65,centrality_df=centrality_df_0.65,gene_list_collection=list(RA_bio_exp=RA_bio_exp),n_rand_lists=10000,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-a0c6da9baa
get_workflow_progress(c('wf-a0c6da9baa')) # SUCCEEDED
mean_centrality_res_0.65 <- readRDS(get_workflow_outputs("wf-a0c6da9baa"))

## Test also the centrality of the top DEGs genes:
top_DEGs_signatures <- readRDS(get_workflow_outputs("wf-a6877657a3"))

(mean_centrality_DEGs_up_down_res_0.6_wf <- cytoreason.cc.client::run_function_dist(test_list_mean_centrality,DM="HC",cor_cut=0.6,centrality_df=centrality_df_0.6,gene_list_collection=top_DEGs_signatures,n_rand_lists=10000,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-98516a1c70
get_workflow_progress(c('wf-98516a1c70')) # SUCCEEDED
mean_centrality_DEGs_up_down_res_0.6 <- readRDS(get_workflow_outputs("wf-98516a1c70"))

(mean_centrality_DEGs_up_down_res_0.65_wf <- cytoreason.cc.client::run_function_dist(test_list_mean_centrality,DM="HC",cor_cut=0.65,centrality_df=centrality_df_0.65,gene_list_collection=top_DEGs_signatures,n_rand_lists=10000,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-6fb03f4dc1
get_workflow_progress(c('wf-6fb03f4dc1')) # SUCCEEDED
mean_centrality_DEGs_up_down_res_0.65 <- readRDS(get_workflow_outputs("wf-6fb03f4dc1"))

# Combine centrality results with previous results (the bio. exp. genes):
# summary_df:
mean_centrality_res_0.6$summary_df$list_type <- "positive_control"; mean_centrality_res_0.6$summary_df$evaluation_network <- "HC"
mean_centrality_res_0.65$summary_df$list_type <- "positive_control"; mean_centrality_res_0.65$summary_df$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.6$summary_df$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.6$summary_df$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.65$summary_df$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.65$summary_df$evaluation_network <- "HC"

HC_network_evaluation_mean_centrality_summary <- rbind(mean_centrality_res_0.6$summary_df,
                                                       mean_centrality_res_0.65$summary_df,
                                                       mean_centrality_DEGs_up_down_res_0.6$summary_df,
                                                       mean_centrality_DEGs_up_down_res_0.65$summary_df)


# gene_list_and_random_mean_values:
mean_centrality_res_0.6$gene_list_and_random_mean_values$list_type <- "positive_control"; mean_centrality_res_0.6$gene_list_and_random_mean_values$evaluation_network <- "HC"
mean_centrality_res_0.65$gene_list_and_random_mean_values$list_type <- "positive_control"; mean_centrality_res_0.65$gene_list_and_random_mean_values$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.6$gene_list_and_random_mean_values$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.6$gene_list_and_random_mean_values$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.65$gene_list_and_random_mean_values$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.65$gene_list_and_random_mean_values$evaluation_network <- "HC"

HC_network_evaluation_random_mean_centrality <- rbind(mean_centrality_res_0.6$gene_list_and_random_mean_values,
                                                      mean_centrality_res_0.65$gene_list_and_random_mean_values,
                                                      mean_centrality_DEGs_up_down_res_0.6$gene_list_and_random_mean_values,
                                                      mean_centrality_DEGs_up_down_res_0.65$gene_list_and_random_mean_values)


# centrality_table:
mean_centrality_res_0.6$centrality_table$list_type <- "positive_control"; mean_centrality_res_0.6$centrality_table$evaluation_network <- "HC"
mean_centrality_res_0.65$centrality_table$list_type <- "positive_control"; mean_centrality_res_0.65$centrality_table$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.6$centrality_table$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.6$centrality_table$evaluation_network <- "HC"
mean_centrality_DEGs_up_down_res_0.65$centrality_table$list_type <- "RA_vs_HC_top_DEGs"; mean_centrality_DEGs_up_down_res_0.65$centrality_table$evaluation_network <- "HC"

HC_network_evaluation_centrality_table <- rbind(mean_centrality_res_0.6$centrality_table,
                                               mean_centrality_res_0.65$centrality_table,
                                               mean_centrality_DEGs_up_down_res_0.6$centrality_table,
                                               mean_centrality_DEGs_up_down_res_0.65$centrality_table)

## Combine with the RA network results:
RA_network_evaluation_mean_centrality_summary <- readRDS(get_workflow_outputs("wf-1697792e3c"))
RA_HC_network_evaluation_mean_centrality_summary <- rbind(RA_network_evaluation_mean_centrality_summary,HC_network_evaluation_mean_centrality_summary)

bq_perform_upload(bq_table("cytoreason","p01_proj_target_signatures_combinations_ra",table="RA_network_evaluation_mean_centrality_summary"),RA_HC_network_evaluation_mean_centrality_summary)

RA_network_evaluation_random_mean_centrality <- readRDS(get_workflow_outputs("wf-94fdea3ff6"))
RA_HC_network_evaluation_random_mean_centrality <- rbind(RA_network_evaluation_random_mean_centrality,HC_network_evaluation_random_mean_centrality)

bq_perform_upload(bq_table("cytoreason","p01_proj_target_signatures_combinations_ra",table="RA_network_evaluation_random_mean_centrality"),RA_HC_network_evaluation_random_mean_centrality)


RA_network_evaluation_centrality_table <- readRDS(get_workflow_outputs("wf-7ee923d45f"))
RA_HC_network_evaluation_centrality_table <- rbind(RA_network_evaluation_centrality_table,HC_network_evaluation_centrality_table)

bq_perform_upload(bq_table("cytoreason","p01_proj_target_signatures_combinations_ra",table="RA_network_evaluation_centrality_table"),RA_HC_network_evaluation_centrality_table)

# Save these tables to cyto-cc:
(cytoreason.cc.client::run_function_dist(retrive_me,my_object=RA_HC_network_evaluation_mean_centrality_summary,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-3d2d17f62d
RA_HC_network_evaluation_mean_centrality_summary <- readRDS(get_workflow_outputs("wf-3d2d17f62d"))

(cytoreason.cc.client::run_function_dist(retrive_me,my_object=RA_HC_network_evaluation_random_mean_centrality,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-1344b580a0
RA_HC_network_evaluation_random_mean_centrality <- readRDS(get_workflow_outputs("wf-1344b580a0"))

(cytoreason.cc.client::run_function_dist(retrive_me,my_object=RA_HC_network_evaluation_centrality_table,image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1")) # wf-b23725a4f7
RA_HC_network_evaluation_centrality_table <- readRDS(get_workflow_outputs("wf-b23725a4f7"))

```

### Test if the intra-density of bio. expected pathways are more than random
```{r}

## Use the bio expectation pathways that we used in Pfizer Q1 2024 to evaluate criteria:
RA_bio_exp_pathways <- readRDS(get_task_inputs("wf-345feeb4da","0")[["signatures"]])

# Full HC network:
(wf_HC_full_cor_bulk_mat <- cytoreason.cc.client::run_function_dist(get_disease_network_cor_mat,
                                                                     NW_wf="wf-7bc0286215",
                                                                     fdr_cutoff=0.05,
                                                                     q_pvalue_cutoff=0.02,
                                                                     image="eu.gcr.io/cytoreason/ci-cytoreason.ccm.pipeline-package:develop_0.55.1",
                                                                     memory_request='70Gi',
                                                                     tags = list(list(name='project',value='p01-target_signatures_in_HC'),
                                                                                 list(name='client',value='p01'),
                                                                                 list(name='object_name',value='HC full cor bulk matrix in wide format, based on wf-7bc0286215 run, filtered based on fdr ≤ 0.05 and q_pvalue ≥ 0.02')),
                                                                     force_execution = TRUE))
# wf-d406d201d0 # SUCCEEDED
get_workflow_progress(c('wf-d406d201d0'))
HC_full_cor_bulk_mat <- readRDS(get_task_outputs('wf-d406d201d0',"0")) # HC bulk full cor matrix in wide format, based on wf-7bc0286215 run, filtered based on fdr ≤ 0.05 and q_pvalue ≥ 0.02

## Run the intra_perturbation_density function:
# For edge_cutoff 0.6
(HC_bio_exp_pathways_intra_density_r_0.6 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.6,
                                                                                   min_bin_size=100L,
                                                                                   signatures=RA_bio_exp_pathways,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-0791fb7ed4 # SUCCEEDED
get_workflow_progress(c('wf-0791fb7ed4'))
HC_bio_exp_pathways_intra_density_r_0.6 <- readRDS(get_task_outputs('wf-0791fb7ed4',"0"))


# For edge_cutoff 0.65
(HC_bio_exp_pathways_intra_density_r_0.65 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.65,
                                                                                   min_bin_size=100L,
                                                                                   signatures=RA_bio_exp_pathways,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-395232120d # SUCCEEDED
get_workflow_progress(c('wf-395232120d'))
HC_bio_exp_pathways_intra_density_r_0.65 <- readRDS(get_task_outputs('wf-395232120d',"0"))


#### Negative controls - we took pathways that are specific to other tissues (not synovium):
RA_negative_bio_exp_pathways <- readRDS(get_task_inputs("wf-a395037d7b","0")[["signatures"]])

# For edge_cutoff 0.6
(HC_negative_bio_exp_pathways_intra_density_r_0.6 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.6,
                                                                                   min_bin_size=100L,
                                                                                   signatures=RA_negative_bio_exp_pathways,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC negative bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-e77b4b16db # SUCCEEDED
get_workflow_progress(c('wf-e77b4b16db'))
HC_negative_bio_exp_pathways_intra_density_r_0.6 <- readRDS(get_task_outputs('wf-e77b4b16db',"0"))


# For edge_cutoff 0.65
(HC_negative_bio_exp_pathways_intra_density_r_0.65 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.65,
                                                                                   min_bin_size=100L,
                                                                                   signatures=RA_negative_bio_exp_pathways,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC negative bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-d956ceac54 # SUCCEEDED
get_workflow_progress(c('wf-d956ceac54'))
HC_negative_bio_exp_pathways_intra_density_r_0.65 <- readRDS(get_task_outputs('wf-d956ceac54',"0"))

### RA_vs_HC DEGs:
top_DEGs_signatures <- readRDS(get_workflow_outputs("wf-a6877657a3"))

# For edge_cutoff 0.6
(HC_top_DEGs_intra_density_r_0.6 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.6,
                                                                                   min_bin_size=100L,
                                                                                   signatures=top_DEGs_signatures,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC negative bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-2efcd6b58b # SUCCEEDED
get_workflow_progress(c('wf-2efcd6b58b'))
HC_top_DEGs_intra_density_r_0.6 <- readRDS(get_task_outputs('wf-2efcd6b58b',"0"))


# For edge_cutoff 0.65
(HC_top_DEGs_intra_density_r_0.65 <- cytoreason.cc.client::run_function_dist(intra_perturbation_density,
                                                                                   cor_mat=HC_full_cor_bulk_mat,
                                                                                   edge_cutoff=0.65,
                                                                                   min_bin_size=100L,
                                                                                   signatures=top_DEGs_signatures,
                                                                                   n_rand_lists=1000L,
                                                                                   n_cores=1,
                                                                                   memory_request='20Gi',
                                                                                   image="eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest",
                                                                                  tags=list(list(name='project',value='p01-target_signatures_in_RA'),list(name='client',value='p01'),list(name='memory_request',value='20Gi'),list(name='image',value='eu.gcr.io/cytoreason/ci-cytoreason.single.cell.preprocessing-package:develop_latest'),list(name='object_name',value='Run intra_perturbation_density on the HC network and HC negative bio expected pathways')),
                                                                                  force_execution = TRUE))
# wf-dc523827ca # SUCCEEDED
get_workflow_progress(c('wf-dc523827ca'))
HC_top_DEGs_intra_density_r_0.65 <- readRDS(get_task_outputs('wf-dc523827ca',"0"))



## Combine the above with the RA results:......
HC_bio_exp_pathways_intra_density_r_0.6$list_type <- "positive_control";HC_bio_exp_pathways_intra_density_r_0.6$evaluation_network <- "HC"
HC_bio_exp_pathways_intra_density_r_0.65$list_type <- "positive_control";HC_bio_exp_pathways_intra_density_r_0.65$evaluation_network <- "HC"
HC_negative_bio_exp_pathways_intra_density_r_0.6$list_type <- "negative_control";HC_negative_bio_exp_pathways_intra_density_r_0.6$evaluation_network <- "HC"
HC_negative_bio_exp_pathways_intra_density_r_0.65$list_type <- "negative_control";HC_negative_bio_exp_pathways_intra_density_r_0.65$evaluation_network <- "HC"
HC_top_DEGs_intra_density_r_0.6$list_type <- "RA_vs_HC_top_DEGs"; HC_top_DEGs_intra_density_r_0.6$evaluation_network <- "HC"
HC_top_DEGs_intra_density_r_0.65$list_type <- "RA_vs_HC_top_DEGs"; HC_top_DEGs_intra_density_r_0.65$evaluation_network <- "HC"

RA_bio_exp_pathways_intra_density_r_0.5 <- readRDS(get_task_outputs('wf-345feeb4da',"0"))
RA_bio_exp_pathways_intra_density_r_0.45 <- readRDS(get_task_outputs('wf-676b0455b0',"0"))
RA_negative_bio_exp_pathways_intra_density_r_0.5 <- readRDS(get_task_outputs('wf-a395037d7b',"0"))
RA_negative_bio_exp_pathways_intra_density_r_0.45 <- readRDS(get_task_outputs('wf-3005cc3eec',"0"))
RA_top_DEGs_intra_density_r_0.5 <- readRDS(get_task_outputs('wf-f753bb983b',"0"))
RA_top_DEGs_intra_density_r_0.45 <- readRDS(get_task_outputs('wf-ade64fb4f3',"0"))

RA_bio_exp_pathways_intra_density_r_0.5 <- RA_bio_exp_pathways_intra_density_r_0.5 %>%
  dplyr::mutate(edge_cutoff = 0.5) %>%
  dplyr::select(edge_cutoff, everything())

RA_bio_exp_pathways_intra_density_r_0.45 <- RA_bio_exp_pathways_intra_density_r_0.45 %>%
  dplyr::mutate(edge_cutoff = 0.45) %>%
  dplyr::select(edge_cutoff, everything())

RA_bio_exp_pathways_intra_density_r_0.5$list_type <- "positive_control"; RA_bio_exp_pathways_intra_density_r_0.5$evaluation_network <- "RA"
RA_bio_exp_pathways_intra_density_r_0.45$list_type <- "positive_control"; RA_bio_exp_pathways_intra_density_r_0.45$evaluation_network <- "RA"
RA_negative_bio_exp_pathways_intra_density_r_0.5$list_type <- "negative_control"; RA_negative_bio_exp_pathways_intra_density_r_0.5$evaluation_network <- "RA"
RA_negative_bio_exp_pathways_intra_density_r_0.45$list_type <- "negative_control"; RA_negative_bio_exp_pathways_intra_density_r_0.45$evaluation_network <- "RA"
RA_top_DEGs_intra_density_r_0.5$list_type <- "RA_vs_HC_top_DEGs"; RA_top_DEGs_intra_density_r_0.5$evaluation_network <- "RA"
RA_top_DEGs_intra_density_r_0.45$list_type <- "RA_vs_HC_top_DEGs"; RA_top_DEGs_intra_density_r_0.45$evaluation_network <- "RA"


RA_evaluation_pathways_intra_density <- rbind(RA_bio_exp_pathways_intra_density_r_0.5,
                                              RA_bio_exp_pathways_intra_density_r_0.45,
                                              RA_negative_bio_exp_pathways_intra_density_r_0.5,
                                              RA_negative_bio_exp_pathways_intra_density_r_0.45,
                                              RA_top_DEGs_intra_density_r_0.5,
                                              RA_top_DEGs_intra_density_r_0.45,
                                              #
                                              HC_bio_exp_pathways_intra_density_r_0.6,
                                              HC_bio_exp_pathways_intra_density_r_0.65,
                                              HC_negative_bio_exp_pathways_intra_density_r_0.6,
                                              HC_negative_bio_exp_pathways_intra_density_r_0.65,
                                              HC_top_DEGs_intra_density_r_0.6,
                                              HC_top_DEGs_intra_density_r_0.65)

# Upload to BQ:
bq_perform_upload(bq_table("cytoreason","p01_proj_target_signatures_combinations_ranking_ra",table="RA_network_evaluation_pathways_intra_density"),RA_evaluation_pathways_intra_density)

subset(RA_evaluation_pathways_intra_density,evaluation_network=="HC")[,c("list_name","list_type","positive_intra_density_FDR")]

```

</details>

<details>

<summary>nodes with centrality of pruned adjusted network</summary>

### nodes with centrality of pruned adjusted network

```{r}

nw_adj_pruned_wf <- "wf-266c522a2d"
#nw_bulk_pruned <- readRDS(get_workflow_outputs(nw_bulk_pruned_wf))
results <-  get_workflow_outputs(nw_adj_pruned_wf)
nw_adj_pruned <- readRDS(results['igraph_NW_sub_0.55.rds',1])
nw_adj_pruned <- igraph::as_data_frame(nw_adj_pruned)
colnames(nw_adj_pruned)[colnames(nw_adj_pruned) %in% "from"] <- "var1"
colnames(nw_adj_pruned)[colnames(nw_adj_pruned) %in% "to"] <- "var2"

wfid <- run_method_dist(method="centrality_measures",
                        ns="analysis.codename",
                        edges=nw_adj_pruned[,c("var1","var2")],
                        memory_request='5Gi',
                        image="eu.gcr.io/cytoreason/ci-analysis.codename-package:adi_latest")

#wf-f254ff53ca

centrality_wf <- "wf-f254ff53ca"

```


### cluster the gene network into modules:
```{R}
#### Bulk:
#HC_bulk_nw <- readRDS(get_workflow_outputs("wf-7bc0286215")) # the HC bulk network
HC_bulk_nw_input <- get_task_inputs("wf-7bc0286215","0") # input used to generate the  HC bulk network
gene_list <- readRDS(HC_bulk_nw_input[["gene_list"]])
group_table <- readRDS(HC_bulk_nw_input[["group_table"]])
assay_element <- readRDS(HC_bulk_nw_input[["assay_element"]])
net_id <- readRDS(HC_bulk_nw_input[["net_id"]])
esets <- readRDS(HC_bulk_nw_input[["esets"]])

IMAGE <- "eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:SUP_4695_1.2.0"

# Run all network stages:
(HC_network_WF <- run_method_dist("service_generate_modules",
                                 ns = "cytoreason.individual.variation",
                                 disease= "healthy",
                                 assay_element= "exprs",
                                 #force_execution = FALSE,
                                 #edges_obj = out$edges_obj,
                                 #steps = c("full_corr_matrix"),
                                 #full_corr_memory="900Gi",
                                 steps = c("network", "modules", "meta-modules", "annotation"),
                                 gene_list=gene_list,
                                 esets=esets,
                                 group_table=group_table,
                                 edge_list.args = list(
                                   min_n_genes = 10000,  #2000,
                                   max_n_genes = 25000,  #was 8000 - maybe change back
                                   qp_val = 0.02,
                                   fdr_val=0.05,
                                   #to_propagate=TRUE,
                                   #info_propagate=NULL,
                                   #fdr_propagate=0.001,
                                   #edge_pruning_corr=c(0.5,0.525,0.55,0.6,0.65),  #bulk
                                   #edge_pruning_corr=c(0.45,0.5,0.525,0.55),  #adj
                                   #to_loo=TRUE,
                                   #assay_element = NULL,
                                   #lean_output=TRUE,
                                   #net_id=NULL,
                                   check_outlier=F,
                                   #save_data_memory_request="20Gi",
                                   internal_data_access="public", # cytoreason.cc.client:::default_data_access(),
                                   def_data_specific_edges=list(cytocc=TRUE,memory_request='30Gi'),
                                   #def_loo=list(memory_request='100Gi'),
                                   def_edge_pruning=list(cytocc=TRUE,memory_request='30Gi')),
                                 module.args = list(
                                   find_cor_th = FALSE,
                                   cor_th=0.6,
                                   fdr_th=0.05,
                                   q_th=0.02,
                                   min_n_edges=10,   #10000,
                                   max_n_edges=200000000,
                                   min_clust = 3,
                                   max_clust = 100,
                                   pathway_collection=c("h","kegg","reactome", "btm","c2.cp"),
                                   net_id=NULL,
                                   # lean_output=FALSE,
                                  #IMAGE="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:develop_0.13.0",
                                  internal_data_access="public", # cytoreason.cc.client:::default_data_access(),
                                  to_enrichment_qc=TRUE,
                                  to_cluster_stability=TRUE,
                                  def_enrich_pathway=list(cytocc=FALSE,memory_request='6Mi', fdr=0.05),
                                  def_enrich_BP=list(cytocc=FALSE,memory_request='6Mi', fdr=0.05),
                                  def_cluster_modules_using_pathway=list(cytocc=FALSE,memory_request='6Mi'),
                                  def_compute_measures=list(cytocc=FALSE,memory_request='6Mi'),
                                  def_enrichment_qc=list(cytocc=TRUE,memory_request='20Gi',n_rand=100),
                                  def_cluster_stability=list(cytocc=TRUE,memory_request='20Gi',n_rand=100,n_sub=100,seed_obs=123,seed_rand=1:100)
                                  # coex_heatmap_edges_th=10
                                  ),
                                 # meta_modules.args = list(
                                 #   #min_clust=5,
                                 #   cor_th=0.5
                                 # ),
                                 memory_request_modules = "99Gi",
                                 memory_request="99Gi",
                                 image="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:SUP_4695_1.2.0",
                                 image_modules="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:SUP_4695_1.2.0",
                                 #image="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:master_1.1.9", # From Revital
                                 #image_modules="eu.gcr.io/cytoreason/ci-cytoreason.individual.variation-package:master_1.1.9", # From Revital
                                 tags=list(list(name="method", value="service_generate_modules"),
                                           list(name="disease", value="healthy"),
                                           list(name="network_type", value="bulk"))))

#wf-3cf08e1723 # SUCCEEDED
get_workflow_progress(c('wf-3cf08e1723'))
HC_bulk_nw_with_modules <- readRDS(get_workflow_outputs("wf-3cf08e1723")) # the HC bulk network
#


```



</details>

<details>

<summary>Export network for Tableau</summary>

### 4 -- export network for Tableau

-- nw tables for dashboards are uploaded here:
['https://console.cloud.google.com/bigquery?project=cytoreason&ws=!1m4!1m3!3m2!1scytoreason!2sp01_proj_target_signatures_combinations_ranking_ra']

--  tables are linked to nw dashboard. can be found here:
['https://analytics.cytoreason.com/#/site/p03/views/JNJmultispecificsinADv6/8_Targetnetworktopology']

```{r}

#load functions

.makeEdgename = function(A,B){
  A = as.numeric(A)
  B = as.numeric(B)
  list = sort(c(A,B))
  return(paste0(list,collapse = "__"))
}
.foo_get_coordinates <- function(net) {
  fr_lay <- layout_with_fr(net, weights = edge_attr(net, "cor"))
  cr_lay <- layout_in_circle(net)
  
  data.frame(entrezid=sapply(strsplit(vertex_attr(net, "name"),"_"),"[",1),
             x1_fr=fr_lay[,1],y1_fr=fr_lay[,2],
             x1_cr=cr_lay[,1],y1_cr=cr_lay[,2], stringsAsFactors = FALSE)
}


# Define the Signature Table

customSignatures <- read_asset("wf-13096e7be3")

fullList = unlist(customSignatures, recursive = FALSE)
names(fullList) = stringr::str_replace(names(fullList),"\\.","__")
fullList <- fullList[!grepl("random", names(fullList))]

fullList_df <- do.call('rbind', lapply(names(fullList), function(cur_geneset) {
  data.frame(geneset=cur_geneset, entrezid=fullList[[cur_geneset]], stringsAsFactors = F)
}))


#convert signature list to dataframe
GenesInSignature_longformat = stack(fullList)
colnames(GenesInSignature_longformat) = c("entrezid","ListName")
GenesInSignature_longformat$collection <- stringr::str_split(GenesInSignature_longformat$ListName,"__",simplify = TRUE)[,1]

#use the full network as a reference to fix coordinates

WF <- run_method_dist(method = "Export_signature_gene_coordinates_disease_nw_global",
                      ns = "analysis.p03.POC1",
                      #GenesInSignature_longformat = GenesInSignature_longformat_sub,
                      wf_nw = "wf-7bc0286215", #full bulk disease nw
                      #SignatureTable=SignatureTable_sub,
                      cor_thr=0,
                      image ="eu.gcr.io/cytoreason/ci-analysis.p03.poc1-package:shiran_API_latest",
                      memory_request = '70Gi')
#wf-d82bcebb73

gene_coordinates <- read_asset("wf-d82bcebb73")
gene_coordinates  <- gene_coordinates %>% dplyr::right_join(GenesInSignature_longformat)

#add collection

gene_coordinates <- gene_coordinates %>% 
  dplyr::rename(Identifier=ListName)

gene_coordinates$helper <- paste(gene_coordinates$Identifier, gene_coordinates$entrezid, sep="___")
fullList_df$helper <- paste(fullList_df$geneset, fullList_df$entrezid, sep="___")
gene_coordinates$in_signature <- ifelse(gene_coordinates$helper %in% fullList_df$helper, 1, 0)
gene_coordinates$helper <- NULL

cyto_cc_push_object(gene_coordinates,"gene_coordinates") 

#wf-b8b22fc90d #september delivery
#wf-64c45d7cbf #updated archs and custom genesets

uploadToBQ(wfid = gene_coordinates, bqdataset = "p01_proj_target_signatures_combinations_ranking_ra", tableName = "network_gene_coordinates")

bulk_disease_nw_wf <- "wf-109135546d"
bulk_disease_nw <- read_asset(bulk_disease_nw_wf)

### ConstructLongEdgeTable #####
EdgeTable <-  data.frame()
bulk_disease_nw <- bulk_disease_nw[!bulk_disease_nw$var1==bulk_disease_nw$var2,]

bulk_edge.clean <-  bulk_disease_nw %>%
  rowwise() %>%
  dplyr::mutate(Edge = .makeEdgename(var1,var2)) %>%
  dplyr::ungroup() %>%
  dplyr::select(Edge,cor) %>%
  unique() %>%
  dplyr::mutate(entrezid = str_split(Edge,"__")) %>%
  unnest(entrezid) %>%
  mutate( symbol =  AnnotationDbi::mapIds(org.Hs.eg.db,  entrezid, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")) %>%
  dplyr::rename(cor = cor) %>%
  left_join(gene_coordinates[,c("entrezid","symbol")]) %>%
  dplyr::mutate(EdgeType = "HC.bulk") %>%
  dplyr::mutate(version = bulk_disease_nw_wf)

#the edges are duplicated because one of the nodes (var1/var2) appears multiple times in the gene_coordinates because it participates in more than one signature
#take the unique

bulk_edge.clean <- bulk_edge.clean %>% distinct()

Genelist = gene_coordinates$entrezid

archs_wf <- "wf-e8302f0ca4"
graph <- readRDS(get_task_outputs(archs_wf, task_id = 0))
archs_network <- graph_from_adjacency_matrix(graph, mode = "undirected", weighted = T, diag = F)

archs_network <- igraph::as_data_frame(archs_network)

#remove self edges

#filter for r>=0.5 (according to Gil's optimization)
#archs_network <- archs_network %>%
#  dplyr::filter(weight >=0.5)

#remove selsf edges
archs_network <- archs_network %>%
  dplyr::filter(from != to)
colnames(archs_network) <- c("var1", "var2", "cor")  
  
archs_edge.clean <-  archs_network %>%
  dplyr::filter(var1 %in%  Genelist) %>%
  dplyr::filter(var2 %in%  Genelist) %>%
  dplyr::select(var1,var2,cor) %>%
  rowwise() %>%
  dplyr::mutate(Edge = .makeEdgename(var1,var2)) %>%
  dplyr::ungroup() %>%
  dplyr::select(Edge,cor) %>%
  unique() %>%
  dplyr::mutate(entrezid = str_split(Edge,"__")) %>%
  unnest(entrezid) %>%
  mutate( symbol =  mapIds(org.Hs.eg.db,  entrezid, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")) %>%
  left_join(gene_coordinates[,c("entrezid","symbol")]) %>%
  dplyr::mutate(EdgeType = "Archs4") %>%
  dplyr::mutate(version = "v1")

archs_edge.clean <- archs_edge.clean %>% distinct()

adj_edge <- read_asset("wf-aeeeac9a85")
adj_edge.clean = adj_edge %>%
  dplyr::filter(var1 %in%  Genelist) %>%
  dplyr::filter(var2 %in%  Genelist) %>%
  dplyr::select(var1,var2,cor) %>%
  rowwise() %>%
  dplyr::mutate(Edge = .makeEdgename(var1,var2)) %>%
  dplyr::ungroup() %>%
  dplyr::select(Edge,cor) %>%
  unique() %>%
  dplyr::mutate(entrezid = str_split(Edge,"__")) %>%
  unnest(entrezid)  %>%
  mutate( symbol =  mapIds(org.Hs.eg.db,  entrezid, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")) %>%
  left_join(gene_coordinates[,c("entrezid","symbol")]) %>%
  dplyr::mutate(EdgeType = "HC.adjusted") %>%
  dplyr::mutate(version = "wf-aeeeac9a85")

adj_edge.clean <- adj_edge.clean %>% distinct()

EdgeTable_combined = rbind(archs_edge.clean,bulk_edge.clean,adj_edge.clean)
cyto_cc_push_object(EdgeTable_combined,"EdgeTable_combined") 
#wf-dc4914550d #september delivery
#wf-e315350209 #updated archs and custom genesets

uploadToBQ(wfid = EdgeTable_combined, bqdataset = "p01_proj_target_signatures_combinations_ranking_ra", tableName = "network_obj_edges_membership")


#### Node Attributes ####
#imputation is done for missing genes in the network

BulkNodeScores <- read_asset("wf-26f40c7c9a") #centrality measures bulk
names(BulkNodeScores)[names(BulkNodeScores) %in% "feature_id"] <- "ENTREZID"
BulkNodeScores = BulkNodeScores %>% 
  dplyr::select(betweenness:page_rank,ENTREZID) %>%
  dplyr::mutate(ENTREZID = as.character(ENTREZID)) %>%
  unique() %>%
  remove_rownames() %>%
  dplyr::rename(entrezid = ENTREZID) %>%
  dplyr::full_join(gene_coordinates[,c("entrezid","symbol")]) %>%
  dplyr::filter(entrezid %in% gene_coordinates$entrezid) %>%
  pivot_longer(cols = betweenness:page_rank,names_to = "parameter",values_to = "value") %>%
  dplyr::mutate(parameter = str_remove(parameter,"node_")) %>%
  dplyr::mutate(imputed = case_when(is.na(value) ~ "yes",
                                    TRUE ~ "no")) %>%
  dplyr::group_by(parameter) %>%
  dplyr::mutate(valueImp = case_when(is.na(value) ~ (min(value,na.rm = TRUE)/2),
                                     TRUE ~ value)) %>%
  dplyr::mutate(adjusted = "no") %>%
  dplyr::mutate(version = "wf-26f40c7c9a")

AdjNodeScores = read_asset("wf-f254ff53ca")
names(AdjNodeScores)[names(AdjNodeScores) %in% "feature_id"] <- "ENTREZID"

AdjNodeScores = AdjNodeScores %>% 
  dplyr::select(betweenness:page_rank,ENTREZID) %>%
  mutate(ENTREZID = as.character(ENTREZID)) %>%
  unique() %>%
  remove_rownames() %>%
  dplyr::rename(entrezid = ENTREZID) %>%
  full_join(gene_coordinates[,c("entrezid","symbol")]) %>%
  dplyr::filter(entrezid %in% gene_coordinates$entrezid) %>%
  pivot_longer(cols = betweenness:page_rank,names_to = "parameter",values_to = "value") %>%
  dplyr::mutate(parameter = str_remove(parameter,"node_")) %>%
  dplyr::mutate(imputed = case_when(is.na(value) ~ "yes",
                                    TRUE ~ "no")) %>%
  group_by(parameter) %>%
  dplyr::mutate(valueImp = case_when(is.na(value) ~ (min(value,na.rm = TRUE)/2),
                                     TRUE ~ value)) %>%
  dplyr::mutate(adjusted = "yes") %>%
  dplyr::mutate(version = "wf-f254ff53ca")

NodeScores = rbind(BulkNodeScores,AdjNodeScores)

NodeScores <- NodeScores[!NodeScores$parameter %in% "closeness",]

NodeScores <- NodeScores %>% distinct()


cyto_cc_push_object(NodeScores,"NodeScores") 
#wf-beca2356e2 

uploadToBQ(wfid = NodeScores, bqdataset = "p01_proj_target_signatures_combinations_ranking_ra", tableName = "network_node_attributes")


```

### 5 -- visualize signature subgraphs in html

#### 5.1 visualize mono

define inputs
```{ r}

#custom genesets
#-----------------

customSignatures <- read_asset("wf-13096e7be3") # top 50

mono_genesets <- customSignatures$monotherapies

```

run visualization function
``` {r}
get_node_positions <- function(network) {
  layout <- layout_with_fr(network)  # Fruchterman-Reingold layout for better visualization
  positions <- data.frame(id = names(V(network)), x = layout[,1], y = layout[,2])
  return(positions)
}

visualize_gene_set_subgraphs <- function(whole_network, gene_sets, centrality_df, centrality_measure = "betweenness") {
  for (i in seq_along(gene_sets)) {
    gene_set <- gene_sets[[i]]
    gene_set <- gene_set[gene_set %in% names(V(whole_network))]
    
    node_positions <- get_node_positions(whole_network)
    
    vids_df <- which(V(whole_network)$name %in% gene_set)
    # Create subgraph for the gene set
    subgraph <- induced_subgraph(whole_network, vids = vids_df)
    
    # Extract node names from the subgraph
    nodes <- V(subgraph)$name
    
    # Merge subgraph nodes with centrality measures
    subgraph_centrality <- centrality_df %>%
      dplyr::filter(feature_id %in% nodes) %>%
      dplyr::arrange(feature_id)
    
    # Prepare data for visNetwork
    nodes_df <- data.frame(
      id = subgraph_centrality$feature_id,
      label = subgraph_centrality$feature_id,
      #color = scales::col_numeric("viridis", domain = NULL)(subgraph_centrality[[centrality_measure]])
      color = scales::col_numeric(palette = c("#f0e3ab", "#f49d77", "#ce5f5f", "#b23030"), domain = NULL)(subgraph_centrality[[centrality_measure]]),
      font.size = 32  # Increase font size
    )
    
    # Add positions to nodes_df
    nodes_df <- merge(nodes_df, node_positions, by = "id", all.x = TRUE)
    
    ann_df_gene_name <- mapIds(keys=as.character(nodes_df$id), x = org.Hs.eg.db, keytype = c("ENTREZID"), column = c("SYMBOL")) %>%
      tibble::enframe(name = "ENTREZID", value = "SYMBOL")
    ann_df_gene_name <- data.frame(ann_df_gene_name, stringsAsFactors = F)
    
    nodes_df$label <- ann_df_gene_name[match(nodes_df$id, ann_df_gene_name$ENTREZID),'SYMBOL']
    
    edges_df <- igraph::as_data_frame(subgraph, what = "edges")
    
    #edges_df$from <- ann_df_gene_name[match(edges_df$from, ann_df_gene_name$ENTREZID),'SYMBOL']
    #edges_df$to <- ann_df_gene_name[match(edges_df$to, ann_df_gene_name$ENTREZID),'SYMBOL']
    
    vis_net <- visNetwork(nodes_df, edges_df) %>%
      visNodes(font = list(size = 20)) %>%  # Increase font size
      visEdges(color = list(color = "gray")) %>%
      visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
      visLayout(randomSeed = 123) %>%
    visPhysics(stabilization = FALSE, 
               solver = "barnesHut",
               barnesHut = list(gravitationalConstant = -8000,
                                centralGravity = 0.3,
                                springLength = 100,
                                springConstant = 0.04,
                                damping = 0.09))  # Disable physics movement
    
    clean_name <- gsub("[^A-Za-z0-9_]", "",  names(gene_sets)[i])
    
    # Save visualization as HTML file
    file_name <- paste0("Gene_Set_", clean_name, "_", centrality_measure, ".html")
    visSave(vis_net, file = file_name)
    cat("Saved visualization to", file_name, "\n")
  }
}


visualize_gene_set_subgraphs(nw_bulk_pruned, mono_genesets, centrality_df, centrality_measure = "page_rank")



```


#### 5.2 visualize combo

define inputs

```{r }

#custom genesets
#-----------------

customSignatures <- read_asset("wf-13096e7be3")
combo_genesets <- customSignatures$dupiMono
mono_genesets <- customSignatures$monotherapies

#categorize genes to unique and overlapping
#--------------------------------------------

categorize_genes <- function(combo_name, combo_genesets, mono_genesets) {
  
  # Split combo_name into mono1 and mono2
  mono1_name <- str_split(combo_name, "-")[[1]][1]
  mono2_name <- str_split_fixed(combo_name, "-", 2)[2]
  
  # Replace "Dupi" with "Dupilumab-50" in mono names
  mono1_name <- ifelse(mono1_name %in% "Dupi", "Dupilumab-50", mono1_name)
  mono2_name <- ifelse(mono2_name %in% "Dupi", "Dupilumab-50", mono2_name)
  
  # Get mono therapy gene sets
  mono1 <- mono_genesets[[mono1_name]]
  mono2 <- mono_genesets[[mono2_name]]
  
  # Identify overlapping and unique genes
  overlapping_genes <- intersect(mono1, mono2)
  mono1_only <- mono1[!mono1 %in% overlapping_genes]
  mono2_only <- mono2[!mono2 %in% overlapping_genes]
  
  # Create data frames for each category, even if empty
  overlapping_genes_df <- if (length(overlapping_genes) > 0) {
    data.frame(entrezid = overlapping_genes, mono_name="overlapping", type = "overlapping", stringsAsFactors = FALSE)
  } else {
    data.frame(entrezid = character(0), mono_name = character(0), type = character(0), stringsAsFactors = FALSE)
  }
  
  mono1_only_df <- if (length(mono1_only) > 0) {
    data.frame(entrezid = mono1_only, mono_name = mono1_name, type="mono_1", stringsAsFactors = FALSE)
  } else {
    data.frame(entrezid = character(0), mono_name = character(0), type=character(0), stringsAsFactors = FALSE)
  }
  
  mono2_only_df <- if (length(mono2_only) > 0) {
    data.frame(entrezid = mono2_only, mono_name = mono2_name, type="mono_2", stringsAsFactors = FALSE)
  } else {
    data.frame(entrezid = character(0), mono_name = character(0),type=character(0), stringsAsFactors = FALSE)
  }
  
  # Combine the data frames
  df <- rbind(mono1_only_df, mono2_only_df, overlapping_genes_df)
  
  return(df)
}


# Process all combination gene sets
results_list <- lapply(names(combo_genesets), function(combo_name) {
  categorize_genes(combo_name, combo_genesets, mono_genesets)
})

names(results_list) <- names(combo_genesets)

combo_df <- do.call('rbind', lapply(names(results_list), function(cur_df) {
  results_list[[cur_df]]$combo_name <- cur_df
  return( results_list[[cur_df]])
}))


#import disease networks
#-------------------------

nw_bulk_pruned_wf <- "wf-2abbb8d3a8"
#nw_bulk_pruned <- readRDS(get_workflow_outputs(nw_bulk_pruned_wf))
results <-  get_workflow_outputs(nw_bulk_pruned_wf)
nw_bulk_pruned <- readRDS(results['igraph_NW_sub_0.5.rds',1])
#nw_bulk_pruned <- igraph::as_data_frame(nw_bulk_pruned)
#colnames(nw_bulk_pruned)[colnames(nw_bulk_pruned) %in% "from"] <- "var1"
#colnames(nw_bulk_pruned)[colnames(nw_bulk_pruned) %in% "to"] <- "var2"

#get precomputed gene level centrality
#--------------------------------------
centrality_df <- read_asset("wf-26f40c7c9a")

```

run visualization
```{r }

#### visualize combo ####
#define function

get_node_positions <- function(network) {
  layout <- layout_with_fr(network)  # Fruchterman-Reingold layout for better visualization
  positions <- data.frame(id = names(V(network)), x = layout[,1], y = layout[,2])
  return(positions)
}

visualize_gene_set_subgraphs <- function(whole_network, gene_sets, centrality_df, final_results, centrality_measure = "betweenness") {
  # Initialize lists to store edges and nodes data frames for each gene set
  edges_list <- list()
  nodes_list <- list()
  
  for (i in seq_along(gene_sets)) {
    gene_set_name <- names(gene_sets)[i]
    gene_set <- gene_sets[[i]]
    gene_set <- gene_set[gene_set %in% names(V(whole_network))]  # Filter genes present in the network
    
    node_positions <- get_node_positions(whole_network)
    
    vids_df <- which(V(whole_network)$name %in% gene_set)
    subgraph <- induced_subgraph(whole_network, vids = vids_df)
    nodes <- V(subgraph)$name
    
    # Merge subgraph nodes with centrality measures
    subgraph_centrality <- centrality_df %>%
      dplyr::filter(feature_id %in% nodes) %>%
      dplyr::arrange(feature_id)
    
    # Use the categorized gene results to assign color categories, filter by the current combo_name
    
    final_results_sub <- final_results[final_results$combo_name %in% gene_set_name,]
    gene_categories <- final_results_sub %>%
      dplyr::filter(entrezid %in% nodes, combo_name == gene_set_name)
    
    # Assign colors based on the category (mono1_only, mono2_only, overlapping)
    nodes_df <- data.frame(
      id = gene_set, 
      stringsAsFactors = FALSE
    )
    
    nodes_df$type <- gene_categories[match(nodes_df$id, gene_categories$entrezid), 'type']
    nodes_df$label <- gene_categories[match(nodes_df$id, gene_categories$entrezid), 'mono_name']
    
    nodes_df$color <- ifelse(nodes_df$type %in% "overlapping", "#FFDDC1", 
                             ifelse(nodes_df$type %in% "mono_1", "#88CCEE", 
                                    ifelse(nodes_df$type %in% "mono_2", "#6495ED", NA)))
    nodes_df$font.size <- 32
    
    # Add positions to nodes_df
    nodes_df <- merge(nodes_df, node_positions, by = "id", all.x = TRUE)
    
    # Annotate gene names using org.Hs.eg.db for human genes
    ann_df_gene_name <- AnnotationDbi::mapIds(keys = as.character(nodes_df$id), x = org.Hs.eg.db, keytype = "ENTREZID", column = "SYMBOL") %>%
      tibble::enframe(name = "ENTREZID", value = "SYMBOL")
    ann_df_gene_name <- data.frame(ann_df_gene_name, stringsAsFactors = FALSE)
    
    nodes_df$label <- ann_df_gene_name[match(nodes_df$id, ann_df_gene_name$ENTREZID), 'SYMBOL']
    
    # Extract edges
    edges_df <- igraph::as_data_frame(subgraph, what = "edges")
    
    # Define intra-mono and inter-mono edges based on mono1_only and mono2_only
    edges_df$from_type <- final_results_sub[match(edges_df$from, final_results_sub$entrezid), 'type']
    edges_df$to_type <- final_results_sub[match(edges_df$to, final_results_sub$entrezid), 'type']
    
    edges_df$from_to_type <- paste(edges_df$from_type, edges_df$to_type, sep = "__")
    
    edges_df <- edges_df %>%
      dplyr::mutate(edge_type = ifelse((from_to_type %in% "mono_1__mono_2") | (from_to_type %in% "mono_2__mono_1"), "inter_mono",
                                       ifelse((from_to_type %in% "mono_1__mono_1") | (from_to_type %in% "mono_2__mono_2"), "intra_mono",
                                              "other")))  # Edge within either mono1_only or mono2_only
    
    # Set different colors for intra and inter edges
    edges_df$color <- ifelse(edges_df$edge_type == "inter_mono", "red", 
                             ifelse(edges_df$edge_type == "intra_mono", "blue", "grey"))
    edges_df$label_to <- nodes_df[match(edges_df$to, nodes_df$id),'label']
    edges_df$label_from <- nodes_df[match(edges_df$from, nodes_df$id),'label']
     
    edges_df$from_mono_label <- final_results_sub[match(edges_df$from, final_results_sub$entrezid),'mono_name']
    edges_df$to_mono_label <- final_results_sub[match(edges_df$to, final_results_sub$entrezid),'mono_name']
    
    # Save edges_df and nodes_df for the current gene set
    edges_list[[gene_set_name]] <- edges_df
    nodes_list[[gene_set_name]] <- nodes_df
    
    # Visualization using visNetwork (optional)
    vis_net <- visNetwork(nodes_df, edges_df) %>%
      visNodes(font = list(size = 45)) %>%
      visEdges(color = list(color = edges_df$color)) %>%
      visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
      visLayout(randomSeed = 123) %>%
      visPhysics(stabilization = FALSE,
             solver = "barnesHut",
             barnesHut = list(gravitationalConstant = -3000,  # Weaker gravitational constant
                              centralGravity = 0.9,  # Much stronger central pull
                              springLength = 20,  # Even shorter spring length
                              springConstant = 0.02,  # Slightly weaker springs to prevent too much clustering
                              damping = 0.1))  # Keep damping moderate
    
    clean_name <- gsub("[^A-Za-z0-9_]", "", gene_set_name)
    
    # Save visualization as HTML file
    file_name <- paste0("Gene_Set_", clean_name, "_", centrality_measure, ".html")
    visSave(vis_net, file = file_name)
    cat("Saved visualization to", file_name, "\n")
  }
  
  # Return the lists of edges_df and nodes_df
  return(list(edges = edges_list, nodes = nodes_list))
}

res_nw <- visualize_gene_set_subgraphs(nw_bulk_pruned, combo_genesets, centrality_df, final_results=combo_df , centrality_measure = "page_rank")


edge_df <- do.call('rbind', lapply(names(res_nw$edges), function(cur_comb) {
  res_nw$edges[[cur_comb]]$geneset <- cur_comb
  return(res_nw$edges[[cur_comb]])
}))

write.csv(edge_df, "~/scratch/subgraphs/combo_modified/edge_df.csv")
cyto_cc_push_object(edge_df,"nw_edge_df")
#wf-f64f0f0be5

```

```{r render, include = FALSE}
if( FALSE ){
  rmarkdown::render("~/code/p03-POC1-analysis/notes/API/new_interface/notebooks/Catalog_project_specific_model.Rmd")
  
}
```
